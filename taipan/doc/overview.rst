***************
System overview
***************

This page is designed to provide a high-level overview of how the
tiling system works. This overview predominantly covers the
:ref:`taipan <taipan>`
module; users should review the TaipanDB documentation for how this is
interfaced with the database system. Simulator/scheduling operations
are described elsewhere (TBD).

Tiling
======

'Tiling' is the generic name for the procedure of assigning any kind of
target (science object, standard, guide, sky, ...) to a particular pointing
of the telescope. As the survey progresses, a series of circular 'tiles' are
built-up across the sky.

To implement this concept in code, we have developed :any:`python` objects
which represent targets in the Taipan survey, and the tiles they may be
assigned to.

:any:`TaipanTarget` objects
---------------------------

:any:`TaipanTarget` objects are basic representations of an astronomical target
for the Taipan survey. The same object class is used to represent all target
types, except for sky fibre positions (see
:ref:`fibrealloc` below). Each :any:`TaipanTarget` object has a set of
Boolean flags denoting which target type(s) it is (it is valid to have a
target used for multiple types; this is not used for Taipan, but, e.g.,
FunnelWeb targets can also act as standard targets as appropriate).

:any:`TaipanTile` objects
-------------------------

:any:`TaipanTile` objects are used to represent configurations of the TAIPAN
instrument. In essence, they are mappings of fibre numbers to
:any:`TaipanTarget` objects already in memory; the position of the fibre
is determined by the recorded position of the mapped :any:`TaipanTarget`. The
object also holds additional information, such as the tile's unique identifier,
field identifier, and other metadata.

Generating tiles
----------------

Single tiles may be generated by:

- Creating a new :any:`TaipanTile` object
- Use the :any:`TaipanTile.unpick_tile` function to assign
  targets to the tile from a pre-loaded list of
  candidate :any:`TaipanTarget` objects
- (Optionally) use the :any:`TaipanTile.repick_tile` function to ensure
  the optimal assignment of fibres to targets (in terms of fibre travel
  distance)

.. _target_selection:

Target selection
^^^^^^^^^^^^^^^^

Notionally, any target within a tile's field of view could be assigned to a
fibre on the tile (:any:`TaipanTile.assign_fibre`). However, there are several
things that need to be considered:

- What target selection scheme will satisfy the survey goals? Are there targets
  that are very important for you to observe as soon as possible, or are you
  more interested in getting an even distribution of a certain type of
  targets?
- Is the target you want currently excluded by other targets? The Starbugs in
  the Taipan instrument have a finite size, so assigning a particular target to
  a tile may exclude that tile from holding certain other targets.

Considering these points leads to the conclusion that some sort of target
prioritisation and ranking is required for the best possible survey
performance. The two key parameters when ranking targets are:

Priority
    Target priority is a user-defined number that attempts to parametrise how
    important the target is to the user. Higher values denote a greater
    importance attached to this target.

Difficulty
    A target's difficulty is defined as the number of targets this target would
    exclude if assigned to a tile. [#f_diff]_ The exclusion is due to the
    ceramic foot of the assigned Starbug (which has a known radius,
    :any:`taipan.core.FIBRE_EXCLUSION_RADIUS`) covering up the other targets.

Distance from the fibre can also be an consideration when determining
how to assign a single fibre (:any:`TaipanTile.assign_fibre`) as opposed to
configuring an entire tile (:any:`TaipanTile.unpick_tile`).

There are multiple ways these values can be combined; see the documentation
for :any:`TaipanTile.assign_fibre` for details. The way that Taipan chooses
to assign targets is the sequential method, with the highest priority target
being assigned first, and any ties settled by selection the most difficult
of those targets.

.. _fibrealloc:

Fibre allocation
^^^^^^^^^^^^^^^^

:ref:`target_selection` dealt with how to select a target for a given fibre.
This section discusses the optimal way to assign targets to a tile as a whole.

Notionally, it would be perfectly valid to call :any:`TaipanTile.assign_fibre`
for each fibre of a tile in sequence. However, there are some penalties
associated with this:

- It's up to the user to determine the best schema for assigning sky, standard
  and guide targets; should they be assigned before or after science targets?
- Multiple calls to :any:`TaipanTile.assign_fibre` will invoke the
  re-computation of the target ranking list for each fibre; on the scale of a
  tile, it is more efficient to calculate this ranking list just once, and use
  it to populate all fibres.

To this end, :any:`taipan.core.TaipanTile` have a built-in
:any:`TaipanTile.unpick_tile` method, which will assign targets to,
or 'unpick', an entire tile. The algorithm for doing this is as follows:

1. Sky fibres are assigned semi-randomly using the :any:`TaipanTile.assign_sky`
   method. It is also possible to assign sky fibres to whatever fibres are
   left over after all other target types have been assigned;
2. Science targets are assigned as per :ref:`target_selection`; however,
   instead of each fibre being allocated a target in sequence, the
   highest-ranked target in the tile is assigned to the nearest available fibre.
   This process is repeated until a full allocation of science targets is made;
3. Assign the required number of standard and guide targets. If the minimum
   number of standard (:any:`taipan.core.STANDARDS_PER_TILE_MIN`) or
   guide (:any:`taipan.core.GUIDES_PER_TILE_MIN`) cannot be reached in the
   current configuration, science targets are removed from the tile to allow
   these limits to be reached.
4. If any normal fibres remain available, further science targets are assigned
   until the list is exhausted or all fibres are assigned.

Note that sky positions are *not* handled by :ref:`taipan`. Fibres assigned to
sky receive a special value of ``'sky'`` instead of a reference to a
:ref:`taipan.core.TaipanTarget`. A separate software routine (Cone of Darkness)
will attempt to position fibres assigned as sky around the assigned target.
Cone of Darkness has authority to switch fibre assignments to assist it in
placing the sky fibres.

.. _simulation:

Simulation
==========

Live Operations
===============

Live operations have yet to be implemented. However, this should be a fairly
straightforward re-packaging of the :ref:`simulation` code,
to be triggered
by the :any:`Jeeves` virtual observer at the appropriate times. The imagined
workflow is as follows:

1. During day time, the code will plan (using
   :any:`taipan.simulate.sim_do_night`) observations for the upcoming evening.
   With the ``instant_dq`` option disabled (and fake data quality analysis
   disabled as well), the remaining tiles will be set as ``queued`` in the
   database.
2. Observing definition files for each queued tile will be written to a
   specified location in the Taipan computing architecture. These tiles will
   contain timestamps in their filenames, allowing :any:`Jeeves` to identify
   which tile to observe when.
3. :any:`Jeeves` will attempt to execute the night's observing plan, as implied
   by the observing definition files present. Not all tiles may be executed due
   to, e.g., weather losses, and on tiles that are observed, not every target
   may be successfully observed.
4. Throughout the night and into the morning, the :any:`TLDR` data reduction
   system will be processing incoming data, and writing the results
   (success/failure) of observations back to the managing database.
5. Once data reduction is complete, all fields affected by the night's
   observations will be re-tiled, removing the existing prepared tiles for those
   fields. This has the effect of folding-in the results from the night's
   observations.

At this point, the sequence returns to step 1.

Under this scheme, the tiling/scheduling code has no work to do overnight.
It is considered wise to allow the scheduler to run during the day, allowing
human operators to confirm it is operating correctly before observations begin.
A later goal of the survey is to implement live re-scheduling. The scheme for
this would be as follows:

.. rubric:: Footnotes

.. [#f_diff] A target is included in its own difficulty count, so the minimum
             possible target difficulty is 1. This avoids problems when
             attempting to multiply/divide by the difficulty, as well as the
             need to strip input lists of the calling target.
